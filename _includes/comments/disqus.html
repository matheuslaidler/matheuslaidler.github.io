<!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = '{{ page.url | absolute_url }}';
    this.page.identifier = '{{ page.url }}';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://{{ site.comments.disqus.shortname }}.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }

  // Tentar injetar CSS no Disqus DEPOIS que carrega, com múltiplas tentativas
  function injectDisqusCSSFix() {
    var isDarkMode = document.documentElement.getAttribute('data-mode') === 'dark' ||
                     (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    
    if (!isDarkMode) return;

    var attempts = 0;
    var maxAttempts = 10;
    
    var checkAndInject = function() {
      attempts++;
      
      var iframes = document.querySelectorAll('#disqus_thread iframe');
      
      for (var i = 0; i < iframes.length; i++) {
        try {
          var frameDoc = iframes[i].contentDocument || iframes[i].contentWindow.document;
          if (frameDoc && frameDoc.body) {
            // Se conseguimos acessar, injetar CSS
            if (!frameDoc.getElementById('disqus-dark-mode-fix')) {
              var style = frameDoc.createElement('style');
              style.id = 'disqus-dark-mode-fix';
              style.textContent = `
                body { background-color: #0f1419 !important; }
                body, div, p, span, a, li, .post-message { color: white !important; }
              `;
              frameDoc.head.appendChild(style);
            }
            return; // Sucesso, parar de tentar
          }
        } catch (e) {
          // CORS ainda bloqueando, tentar novamente
        }
      }
      
      // Se não conseguiu e ainda tem tentativas, tentar novamente
      if (attempts < maxAttempts) {
        setTimeout(checkAndInject, 500);
      }
    };
    
    // Começar tentativas após 1 segundo
    setTimeout(checkAndInject, 1000);
  }

  // Chamar função quando página carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', injectDisqusCSSFix);
  } else {
    injectDisqusCSSFix();
  }
</script>
